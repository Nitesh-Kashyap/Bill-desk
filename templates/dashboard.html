{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Dashboard</h3>
<p class="text-muted">Quick overview and actions.</p>

<div class="row g-4">
  <!-- Products Card -->
  <div class="col-md-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Products (latest)</h5>

        <!-- Search box -->
        <input type="text" id="searchBox" class="form-control mb-2" placeholder="Search products...">

        <div class="table-responsive">
          <table class="table table-striped table-hover" id="productsTable">
            <thead>
              <tr>
                <th onclick="sortTable(0)">Name ⬍</th>
                <th onclick="sortTable(1)">Price ⬍</th>
                <th onclick="sortTable(2)">Stock ⬍</th>
              </tr>
            </thead>
            <tbody>
              {% for p in products[:5] %}
              <tr>
                <td>{{ p.name }}</td>
                <td>{{ '%.2f'|format(p.price) }}</td>
                <td>{{ p.stock }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted">No products yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <a href="{{ url_for('products_page') }}" class="btn btn-outline-primary btn-sm">Manage Products</a>
      </div>
    </div>
  </div>

  <!-- Billing Card -->
  <div class="col-md-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body d-flex flex-column justify-content-between">
        <div>
          <h5 class="card-title">Create a Bill</h5>
          <p class="text-muted">Select items, apply discount and generate a PDF invoice.</p>
        </div>
        <a href="{{ url_for('new_bill') }}" class="btn btn-primary mt-3">New Bill</a>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for search and sort -->
<script>
  // Live search filter
  document.getElementById("searchBox").addEventListener("keyup", function(){
    let filter = this.value.toLowerCase();
    let rows = document.querySelectorAll("#productsTable tbody tr");
    rows.forEach(row => {
      let text = row.innerText.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  });

  // Sort table by column
  function sortTable(n) {
    let table = document.getElementById("productsTable");
    let switching = true, dir = "asc", switchcount = 0;
    while (switching) {
      switching = false;
      let rows = table.rows;
      for (let i = 1; i < rows.length - 1; i++) {
        let shouldSwitch = false;
        let x = rows[i].getElementsByTagName("TD")[n];
        let y = rows[i + 1].getElementsByTagName("TD")[n];
        let cmpX = isNaN(x.innerHTML) ? x.innerHTML.toLowerCase() : parseFloat(x.innerHTML);
        let cmpY = isNaN(y.innerHTML) ? y.innerHTML.toLowerCase() : parseFloat(y.innerHTML);
        if (dir == "asc" ? cmpX > cmpY : cmpX < cmpY) {
          shouldSwitch = true;
          break;
        }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        switchcount++;
      }
      }
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
</script>

{% endblock %}
